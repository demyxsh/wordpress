#!/bin/bash
# Demyx
# https://demyx.sh
set -eEuo pipefail
#
#	Main.
#
demyx_sudo() {
	local DEMYX_SUDO="${1:-}"

	case "$DEMYX_SUDO" in
		cron)
			demyx_sudo_cron
		;;
		php)
			demyx_sudo_php
		;;
		*)
			# Execute all sudo functions
			demyx_sudo_cron
			demyx_sudo_php
		;;
	esac
}
#
#	Cron.
#
demyx_sudo_cron() {
	local DEMYX_SUDO_CRON=
	DEMYX_SUDO_CRON="$(pgrep crond || true)"

	{
		# WP cron
		echo "${DEMYX_CRON_WP_INTERVAL} /usr/bin/sudo -E /usr/local/bin/demyx-cron wp"

		# ACL
		echo "0 0 * * * /usr/bin/sudo -E /usr/local/bin/demyx-cron acl"

		# User defined cron
		if [[ -f "$DEMYX_CONFIG"/custom/cron ]]; then
			cat < "$DEMYX_CONFIG"/custom/cron
		fi
	} | sed 's|"||g' > /etc/crontab

	crontab -u demyx /etc/crontab

	if [[ "$DEMYX_CRON" = true && -z "$DEMYX_SUDO_CRON" ]]; then
		crond
	fi
}
#
#	PHP.
#
demyx_sudo_php() {
	case "$DEMYX_PHP" in
        8.3|83)
            DEMYX_PHP=83
        ;;
        *)
            DEMYX_PHP=82
        ;;
    esac

	ln -sf /usr/bin/php"${DEMYX_PHP}" /usr/bin/php
	ln -sf /usr/sbin/php-fpm"${DEMYX_PHP}" /usr/sbin/php-fpm
}
#
#	Init.
#
demyx_sudo "$@"
